{% extends "tracker/base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>ðŸ“» Radios</h2>

    <!-- Section d'actualisation par lot -->
    <div class="container mt-4">
        <h2>Actualisation de la base Radio Browser</h2>
        <button id="refresh-btn" class="btn btn-primary">
            ðŸ”„ Actualiser la base
        </button>
        <span id="radios-count">Nombre de radios actuellement en base : <strong>{{ radios_count }}</strong></span>
        <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="force-checkbox" name="force">
            <label class="form-check-label" for="force-checkbox">
                Forcer la mise Ã  jour des adresses email
            </label>
        </div>

        <!-- Popup de progression -->
        <div class="modal fade" id="progressModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Actualisation en cours...</h5>
                    </div>
                    <div class="modal-body">
                        <p id="current-country" class="fw-bold"></p>
                        <div class="progress" style="height: 25px;">
                            <div id="refresh-progress"
                                 class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                0%
                            </div>
                        </div>
                        <div id="refresh-messages" class="mt-3 small"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire de recherche -->
    <form method="get" class="row g-3 mb-4 mt-4">
        <div class="col-md-4">
            <label for="country" class="form-label">Pays</label>
            <select id="country" name="country" class="selectpicker" multiple data-live-search="true" title="SÃ©lectionner pays">
                {% for c in countries %}
                <option value="{{ c }}" {% if c in selected_countries %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label for="state" class="form-label">RÃ©gion</label>
            <select id="state" name="state" class="selectpicker" multiple data-live-search="true" title="SÃ©lectionner rÃ©gion">
                {% for s in states %}
                <option value="{{ s }}" {% if s in selected_states %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label for="tag" class="form-label">Style</label>
            <select id="tag" name="tag" class="selectpicker" multiple data-live-search="true" title="SÃ©lectionner style">
                {% for t in tags %}
                <option value="{{ t }}" {% if t in selected_tags %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-12 mt-2">
            <button type="submit" class="btn btn-primary">
                Rechercher
            </button>
            <span class="ms-2">
                {% if page_obj %}
                    Affichage {{ page_obj.start_index }}â€“{{ page_obj.end_index }} / {{ page_obj.paginator.count }}
                {% else %}
                    RÃ©sultats : <strong>{{ radios|length }}</strong>
                {% endif %}
            </span>
        </div>
    </form>

    <!-- Table des rÃ©sultats -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Nom</th>
                    <th>Pays</th>
                    <th>RÃ©gion</th>
                    <th>Style</th>
                    <th>Site Web</th>
                    <th>Email</th>
                </tr>
            </thead>
            <tbody>
                {% for r in radios %}
                <tr>
                    <td>{{ r.name }}</td>
                    <td>{{ r.country }}</td>
                    <td>{{ r.state }}</td>
                    <td>{{ r.tags|truncatechars:50 }}</td>
                    <td>
                        {% if r.homepage %}
                        <a href="{{ r.homepage }}" target="_blank">{{ r.homepage }}</a>
                        {% endif %}
                    </td>
                    <td>{{ r.emails }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">Aucune radio trouvÃ©e.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if page_obj and page_obj.paginator.num_pages > 1 %}
    <nav aria-label="Pagination radios">
        <ul class="pagination justify-content-center mt-3">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for c in selected_countries %}&country={{ c }}{% endfor %}{% for s in selected_states %}&state={{ s }}{% endfor %}{% for t in selected_tags %}&tag={{ t }}{% endfor %}">&laquo; PrÃ©cÃ©dent</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo; PrÃ©cÃ©dent</span></li>
            {% endif %}

            <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for c in selected_countries %}&country={{ c }}{% endfor %}{% for s in selected_states %}&state={{ s }}{% endfor %}{% for t in selected_tags %}&tag={{ t }}{% endfor %}">Suivant &raquo;</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Suivant &raquo;</span></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    <!-- Boutons d'export -->
    <div class="mt-3">
        <a href="{% url 'export_xlsx' %}" class="btn btn-success me-2">ðŸ“¥ Export XLSX</a>
        <a href="{% url 'export_pdf' %}" class="btn btn-info">ðŸ“¥ Export PDF</a>
    </div>
</div>
{% endblock %}
